# Sistema de Documentos de Pr√©stamos - AlphaCredit

## Descripci√≥n General

Se ha implementado un sistema completo de generaci√≥n de documentos para pr√©stamos, incluyendo:

1. **Contrato de Pr√©stamo** - Documento legal basado en normativa hondure√±a
2. **Pagar√©** - Documento de compromiso de pago
3. **Plan de Pagos** - Tabla de amortizaci√≥n detallada
4. **Control de Impresiones** - Auditor√≠a de todas las impresiones de documentos

## Caracter√≠sticas Principales

### üîí Restricci√≥n de Edici√≥n de Pr√©stamos

- **Los pr√©stamos NO pueden editarse una vez creados**
- Esta restricci√≥n aplica tanto en el frontend como en el backend
- Raz√≥n: Integridad financiera y auditor√≠a
- El endpoint PUT `/api/prestamos/{id}` retorna error 400 con mensaje explicativo
- En el frontend, si se intenta editar un pr√©stamo, se muestra una pantalla informativa

### üìÑ Documentos Generados

#### 1. Contrato de Pr√©stamo
- Documento HTML formateado para impresi√≥n
- Incluye todas las cl√°usulas legales basadas en normativa hondure√±a:
  - Objeto del contrato
  - Intereses y tasas
  - Plazo y forma de pago
  - Cl√°usulas de mora
  - Garant√≠as (si existen)
  - Legislaci√≥n aplicable
- Conversi√≥n autom√°tica de n√∫meros a letras
- Espacios para firmas del acreedor y deudor

#### 2. Pagar√©
- Formato legal v√°lido en Honduras
- Incluye monto total a pagar (capital + intereses)
- Fecha de vencimiento
- Cl√°usulas de mora e incumplimiento
- Espacio para firma del deudor

#### 3. Plan de Pagos
- Tabla completa de amortizaci√≥n
- Desglose por cuota: capital, inter√©s, cuota total, saldo
- Informaci√≥n del pr√©stamo y cliente
- Resumen de totales
- Dise√±o profesional para impresi√≥n

### üìä Control de Impresiones

El sistema registra autom√°ticamente:
- **Fecha y hora** de cada impresi√≥n
- **Usuario** que gener√≥ el documento
- **Direcci√≥n IP** desde donde se imprimi√≥
- **Contador de impresiones** por documento
- **Primera y √∫ltima impresi√≥n** de cada documento

### üí∞ Parametrizaci√≥n de Moneda

#### Configuraci√≥n (`.env`)
```env
REACT_APP_CURRENCY_LOCALE=es-HN
REACT_APP_CURRENCY_CODE=HNL
REACT_APP_CURRENCY_SYMBOL=L
```

#### Utilidad de Formateo
Se ha creado una utilidad centralizada en `/src/utils/currency.js`:

```javascript
import { formatCurrency } from '../../utils/currency';

// Uso:
formatCurrency(1000)  // Retorna: "L 1,000.00"
formatCurrency(1500.50, 0, 0)  // Sin decimales: "L 1,501"
```

**Todos los archivos del frontend ahora usan esta utilidad**, asegurando consistencia en el formato de moneda Lempiras (HNL).

## Base de Datos

### Nuevas Tablas

#### `prestamo_documento`
Almacena los documentos generados:
- `prestamo_documentoid` (PK)
- `prestamoid` (FK)
- `prestamo_documento_tipo` (CONTRATO, PAGARE, PLAN_PAGOS)
- `prestamo_documento_veces_impreso`
- `prestamo_documento_fecha_primera_impresion`
- `prestamo_documento_fecha_ultima_impresion`
- Auditor√≠a: user_crea, fecha_creacion

#### `prestamo_documento_impresion`
Registro detallado de cada impresi√≥n:
- `prestamo_documento_impresionid` (PK)
- `prestamo_documentoid` (FK)
- `prestamo_documento_impresion_fecha`
- `prestamo_documento_impresion_usuario`
- `prestamo_documento_impresion_ip`
- `prestamo_documento_impresion_observaciones`

### Vistas y Funciones

#### Vista: `v_prestamo_documentos_estadisticas`
Muestra estad√≠sticas completas de documentos por pr√©stamo.

#### Funci√≥n: `fn_registrar_impresion_documento`
Registra autom√°ticamente una impresi√≥n y actualiza contadores.

```sql
SELECT fn_registrar_impresion_documento(
    p_prestamo_id := 1,
    p_tipo_documento := 'CONTRATO',
    p_usuario := 'admin',
    p_ip := '192.168.1.100'
);
```

### Migraci√≥n SQL

La migraci√≥n se encuentra en:
```
backend/migrations/005_prestamo_documentos.sql
```

**Ejecutar con:**
```bash
psql -U postgres -d alphacredit -f backend/migrations/005_prestamo_documentos.sql
```

## API Endpoints

### Generaci√≥n de Documentos

#### `GET /api/prestamos/{id}/documentos/contrato`
Genera el contrato de pr√©stamo.

**Query Params:**
- `usuario` (opcional): Usuario que genera el documento

**Response:** HTML del contrato

**Ejemplo:**
```bash
GET /api/prestamos/1/documentos/contrato?usuario=admin
```

#### `GET /api/prestamos/{id}/documentos/pagare`
Genera el pagar√© del pr√©stamo.

**Query Params:**
- `usuario` (opcional): Usuario que genera el documento

**Response:** HTML del pagar√©

#### `GET /api/prestamos/{id}/documentos/plan-pagos`
Genera el plan de pagos del pr√©stamo.

**Query Params:**
- `usuario` (opcional): Usuario que genera el documento

**Response:** HTML del plan de pagos

### Auditor√≠a y Estad√≠sticas

#### `GET /api/prestamos/{id}/documentos/historial`
Obtiene el historial de impresiones de un documento.

**Query Params:**
- `tipoDocumento` (requerido): CONTRATO, PAGARE o PLAN_PAGOS

**Response:**
```json
{
  "prestamoId": 1,
  "tipoDocumento": "CONTRATO",
  "totalImpresiones": 3,
  "impresiones": [
    {
      "fecha": "2025-10-19T10:30:00Z",
      "usuario": "admin",
      "ip": "192.168.1.100",
      "observaciones": null
    }
  ]
}
```

#### `GET /api/prestamos/{id}/documentos/estadisticas`
Obtiene estad√≠sticas de todos los documentos de un pr√©stamo.

**Response:**
```json
{
  "prestamoId": 1,
  "documentos": [
    {
      "tipo": "CONTRATO",
      "vecesImpreso": 3,
      "primeraImpresion": "2025-10-19T10:00:00Z",
      "ultimaImpresion": "2025-10-19T15:30:00Z"
    },
    {
      "tipo": "PAGARE",
      "vecesImpreso": 2,
      "primeraImpresion": "2025-10-19T10:05:00Z",
      "ultimaImpresion": "2025-10-19T14:00:00Z"
    }
  ]
}
```

#### `PUT /api/prestamos/{id}` (DESHABILITADO)
Retorna error 400.

**Response:**
```json
{
  "message": "Los pr√©stamos no pueden ser modificados una vez creados por razones de integridad financiera y auditor√≠a.",
  "code": "PRESTAMO_NO_EDITABLE"
}
```

## Frontend

### Componente: PrestamoDocumentosModal

Componente React para gestionar documentos de pr√©stamos.

**Ubicaci√≥n:** `frontend/alphacredit-app/src/components/common/PrestamoDocumentosModal.js`

**Props:**
- `isOpen` (boolean): Controla visibilidad del modal
- `onClose` (function): Callback para cerrar el modal
- `prestamo` (object): Objeto del pr√©stamo con sus datos

**Caracter√≠sticas:**
- Visualizaci√≥n de estad√≠sticas de documentos
- Botones para generar e imprimir cada documento
- Historial detallado de impresiones
- Interfaz intuitiva con iconos y badges

**Uso:**
```jsx
import PrestamoDocumentosModal from '../../components/common/PrestamoDocumentosModal';

function PrestamosList() {
  const [showDocs, setShowDocs] = useState(false);
  const [prestamoSeleccionado, setPrestamoSeleccionado] = useState(null);

  return (
    <>
      <button onClick={() => {
        setPrestamoSeleccionado(prestamo);
        setShowDocs(true);
      }}>
        Ver Documentos
      </button>

      <PrestamoDocumentosModal
        isOpen={showDocs}
        onClose={() => setShowDocs(false)}
        prestamo={prestamoSeleccionado}
      />
    </>
  );
}
```

### Servicio: prestamoDocumentoService

**Ubicaci√≥n:** `frontend/alphacredit-app/src/services/prestamoDocumentoService.js`

**M√©todos:**

```javascript
// Generar documentos
await prestamoDocumentoService.generarContrato(prestamoId, usuario);
await prestamoDocumentoService.generarPagare(prestamoId, usuario);
await prestamoDocumentoService.generarPlanPagos(prestamoId, usuario);

// Auditor√≠a
await prestamoDocumentoService.obtenerHistorialImpresiones(prestamoId, 'CONTRATO');
await prestamoDocumentoService.obtenerEstadisticas(prestamoId);

// Imprimir (abre ventana nueva)
prestamoDocumentoService.imprimirDocumento(htmlContent, 'Contrato');
```

### Restricci√≥n de Edici√≥n en Frontend

El componente `PrestamoForm` detecta autom√°ticamente si est√° en modo edici√≥n:

```jsx
// Si isEditMode = true (URL: /prestamos/edit/:id)
// Muestra pantalla bloqueada con mensaje:
"‚ö†Ô∏è Pr√©stamo No Editable"
"Por razones de integridad financiera y auditor√≠a,
los pr√©stamos no pueden modificarse una vez creados."
```

## Backend

### Servicio: PrestamoDocumentoService

**Ubicaci√≥n:** `backend/AlphaCredit.Api/Services/PrestamoDocumentoService.cs`

**M√©todos principales:**

```csharp
// Generaci√≥n de documentos
Task<string> GenerarContratoPrestamo(long prestamoId)
Task<string> GenerarPagare(long prestamoId)
Task<string> GenerarPlanPagos(long prestamoId)

// Control de impresiones
Task<PrestamoDocumento> RegistrarImpresion(long prestamoId, string tipoDocumento, string usuario, string? ip)
Task<List<PrestamoDocumentoImpresion>> ObtenerHistorialImpresiones(long prestamoId, string tipoDocumento)
```

**Caracter√≠sticas t√©cnicas:**
- Conversi√≥n de n√∫meros a letras (espa√±ol)
- Generaci√≥n de HTML con estilos inline
- C√°lculo autom√°tico de totales
- Integraci√≥n con servicio de amortizaci√≥n
- Hash de documentos para verificar integridad (futuro)

### Modelos

#### PrestamoDocumento
```csharp
public class PrestamoDocumento
{
    public long PrestamoDocumentoId { get; set; }
    public long PrestamoId { get; set; }
    public string PrestamoDocumentoTipo { get; set; }
    public int PrestamoDocumentoVecesImpreso { get; set; }
    public DateTime? PrestamoDocumentoFechaPrimeraImpresion { get; set; }
    public DateTime? PrestamoDocumentoFechaUltimaImpresion { get; set; }
    // ... navegaci√≥n y auditor√≠a
}
```

#### PrestamoDocumentoImpresion
```csharp
public class PrestamoDocumentoImpresion
{
    public long PrestamoDocumentoImpresionId { get; set; }
    public long PrestamoDocumentoId { get; set; }
    public DateTime PrestamoDocumentoImpresionFecha { get; set; }
    public string? PrestamoDocumentoImpresionUsuario { get; set; }
    public string? PrestamoDocumentoImpresionIp { get; set; }
    // ... navegaci√≥n
}
```

## Flujo de Uso

### 1. Crear un Pr√©stamo
```
1. Usuario crea pr√©stamo en /prestamos/new
2. Sistema genera autom√°ticamente:
   - N√∫mero de pr√©stamo
   - Tabla de amortizaci√≥n
   - Componentes (capital e inter√©s)
   - Movimiento de fondo (desembolso)
3. Pr√©stamo queda BLOQUEADO para edici√≥n
```

### 2. Generar Documentos
```
1. Usuario accede a lista de pr√©stamos
2. Click en "Ver Documentos" del pr√©stamo deseado
3. Se abre modal con 3 documentos disponibles:
   - Contrato de Pr√©stamo
   - Pagar√©
   - Plan de Pagos
4. Usuario selecciona documento y click en "Generar e Imprimir"
5. Sistema:
   - Genera HTML del documento
   - Registra impresi√≥n en BD
   - Abre ventana nueva con documento
   - Ejecuta comando de impresi√≥n del navegador
6. Estad√≠sticas se actualizan autom√°ticamente
```

### 3. Consultar Historial
```
1. En modal de documentos, click en "Ver Historial"
2. Se muestra tabla con:
   - Fecha y hora de cada impresi√≥n
   - Usuario que imprimi√≥
   - IP de origen
3. Click en "Ocultar Historial" para cerrar
```

## Normativa Legal (Honduras)

Los documentos generados incluyen cl√°usulas basadas en:

- **C√≥digo de Comercio de Honduras**
- **C√≥digo Civil de Honduras**
- Regulaciones de la **Comisi√≥n Nacional de Bancos y Seguros (CNBS)**

### Cl√°usulas Principales

1. **Del Objeto**: Monto, entrega y obligaci√≥n de devoluci√≥n
2. **De los Intereses**: Tasa anual y c√°lculo
3. **Del Plazo y Forma de Pago**: Cuotas y fechas
4. **De la Mora**: Intereses moratorios y vencimiento anticipado
5. **De las Garant√≠as**: Listado de garant√≠as constituidas
6. **Del Domicilio**: Domicilio del deudor
7. **De la Legislaci√≥n Aplicable**: Leyes hondure√±as

## Seguridad y Auditor√≠a

### Registro Autom√°tico
- Cada generaci√≥n/impresi√≥n se registra autom√°ticamente
- No es posible generar documentos sin registro
- IP del cliente se captura autom√°ticamente

### Integridad de Datos
- Pr√©stamos inmutables despu√©s de creaci√≥n
- Hash de documentos (preparado para futura implementaci√≥n)
- √çndices √∫nicos en BD para evitar duplicados

### Trazabilidad
- Fecha/hora de primera y √∫ltima impresi√≥n
- Contador de veces impreso
- Usuario responsable de cada impresi√≥n
- Historial completo de acciones

## Testing

### Backend

```bash
# Probar generaci√≥n de contrato
curl http://localhost:5000/api/prestamos/1/documentos/contrato?usuario=test

# Probar estad√≠sticas
curl http://localhost:5000/api/prestamos/1/documentos/estadisticas

# Probar historial
curl "http://localhost:5000/api/prestamos/1/documentos/historial?tipoDocumento=CONTRATO"
```

### Frontend

1. Crear un pr√©stamo de prueba
2. Ir a lista de pr√©stamos
3. Click en "Ver Documentos"
4. Probar generaci√≥n de cada documento
5. Verificar que se abra ventana de impresi√≥n
6. Revisar estad√≠sticas actualizadas
7. Ver historial de impresiones

## Pr√≥ximas Mejoras

### Funcionalidades Pendientes
- [ ] Exportaci√≥n a PDF (usando biblioteca como jsPDF o iText)
- [ ] Firma digital de documentos
- [ ] Env√≠o de documentos por email
- [ ] Plantillas personalizables por sucursal
- [ ] Almacenamiento de PDFs generados en sistema de archivos
- [ ] Verificaci√≥n de integridad con hash SHA-256
- [ ] Documentos adicionales (comprobantes de pago, cartas de liberaci√≥n)
- [ ] Marca de agua en documentos

### Mejoras T√©cnicas
- [ ] Cach√© de documentos generados
- [ ] Compresi√≥n de HTML
- [ ] Mejora en conversi√≥n de n√∫meros a letras (decimales)
- [ ] Soporte multi-idioma
- [ ] Pruebas unitarias e integraci√≥n
- [ ] Documentaci√≥n OpenAPI/Swagger

## Troubleshooting

### El documento no se imprime
- Verificar que las ventanas emergentes est√©n habilitadas
- Revisar configuraci√≥n de impresora predeterminada
- Comprobar que JavaScript est√© habilitado

### Error "PRESTAMO_NO_EDITABLE"
- Es comportamiento esperado
- Los pr√©stamos no se pueden editar una vez creados
- Contactar administrador si requiere cambios

### Estad√≠sticas no se actualizan
- Refrescar el modal cerrando y abriendo nuevamente
- Verificar conexi√≥n a la API
- Revisar consola del navegador para errores

### Formato de moneda incorrecto
- Verificar archivo `.env` tenga configuraci√≥n correcta:
  ```
  REACT_APP_CURRENCY_CODE=HNL
  REACT_APP_CURRENCY_LOCALE=es-HN
  ```
- Reiniciar servidor de desarrollo despu√©s de cambiar `.env`

## Soporte

Para preguntas o problemas:
- Revisar logs del backend: `backend/logs/`
- Revisar consola del navegador (F12)
- Contactar al equipo de desarrollo

---

**Versi√≥n:** 1.0.0
**Fecha:** Octubre 2025
**Autor:** Sistema AlphaCredit
**Licencia:** Propietaria
